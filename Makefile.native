#
# Native SimAVR Build Makefile
# Builds SimAVR as native library and executable for Node.js backend service
#

CC = gcc
CFLAGS = -O2 -Wall -Wextra -fPIC -std=c99
LDFLAGS = -shared
AR = ar
ARFLAGS = rcs

# Directories
SRC_DIR = .
LIB_DIR = lib
BIN_DIR = bin
INCLUDE_DIR = include
ROOT_DIR := $(shell pwd)

# Source files (same as WebAssembly build)
SOURCES = simavr/sim/sim_avr.c \
          simavr/sim/sim_core.c \
          simavr/sim/sim_io.c \
          simavr/sim/sim_irq.c \
          simavr/sim/sim_cycle_timers.c \
          simavr/sim/sim_gdb.c \
          simavr/sim/sim_hex.c \
          simavr/sim/sim_interrupts.c \
          simavr/sim/sim_cmds.c \
          simavr/sim/sim_vcd_file.c \
          simavr/sim/sim_utils.c \
          simavr/sim/avr_eeprom.c \
          simavr/sim/avr_flash.c \
          simavr/sim/avr_watchdog.c \
          simavr/sim/avr_extint.c \
          simavr/sim/avr_ioport.c \
          simavr/sim/avr_uart.c \
          simavr/sim/avr_usb.c \
          simavr/sim/avr_acomp.c \
          simavr/sim/avr_adc.c \
          simavr/sim/avr_timer.c \
          simavr/sim/avr_spi.c \
          simavr/sim/avr_twi.c \
          sim/avr_gpio_monitor.c \
          sim/avr_gpio_inject.c \
          sim/avr_serial_monitor.c \
          sim/sim_log.c \
          simavr/sim/avr_lin.c \
          simavr/sim/avr_usi.c \
          simavr/sim/sim_elf.c

# Add all cores dynamically
SOURCES += $(wildcard simavr/cores/*.c)

# Object files
OBJECTS = $(SOURCES:%.c=%.o)

# Include paths
INCLUDES = -I$(ROOT_DIR)/simavr/cores -I$(ROOT_DIR)/simavr/sim -I$(ROOT_DIR)/sim -I$(ROOT_DIR)/include -I$(ROOT_DIR) -DCONFIG_SIMAVR_VERSION=\"1.0.0\"

# Build targets
all: headers $(LIB_DIR)/libsimavr.a $(LIB_DIR)/libsimavr.so $(BIN_DIR)/simavr

# Config generation
headers: simavr/sim/sim_core_config.h simavr/sim/sim_core_decl.h

simavr/sim/sim_core_config.h:
	@echo "ðŸ”§ Generating sim_core_config.h in $(ROOT_DIR)..."
	@echo "#ifndef __SIM_CORE_CONFIG_H__" > $@
	@echo "#define __SIM_CORE_CONFIG_H__" >> $@
	@for core in simavr/cores/*.c ; do \
		if grep -q "SIM_MMCU" $$core; then \
			file=$${core}; global=$${core/simavr\/cores\/sim_}; global=$${global/.c}; \
			upper=$$(echo $$global|tr '[a-z]' '[A-Z]'); \
			echo "#define CONFIG_$$upper 1" >> $@; \
		fi \
	done
	@echo "#endif" >> $@

simavr/sim/sim_core_decl.h: simavr/sim/sim_core_config.h
	@echo "ðŸ”§ Generating sim_core_decl.h in $(ROOT_DIR)..."
	@echo "#ifndef __SIM_CORE_DECL_H__" > $@
	@echo "#define __SIM_CORE_DECL_H__" >> $@
	@echo "extern const struct avr_kind_t * avr_kind[];" >> $@
	@for core in simavr/cores/*.c ; do \
		if grep -q "SIM_MMCU" $$core; then \
			file=$${core}; global=$${core/simavr\/cores\/sim_}; global=$${global/.c}; \
			echo "extern const struct avr_kind_t $$global;" >> $@; \
		fi \
	done
	@echo "#endif" >> $@

# Ensure headers are generated before compiling any object
$(OBJECTS): | headers

# Static library
$(LIB_DIR)/libsimavr.a: $(OBJECTS) simavr/sim/avr_kind_emscripten.o
	@echo "ðŸ“¦ Building static library..."
	@mkdir -p $(LIB_DIR)
	$(AR) $(ARFLAGS) $@ $^
	@echo "âœ… Static library built: $@"

# Shared library
$(LIB_DIR)/libsimavr.so: $(OBJECTS) simavr/sim/avr_kind_emscripten.o
	@echo "ðŸ“¦ Building shared library..."
	@mkdir -p $(LIB_DIR)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
	@echo "âœ… Shared library built: $@"

# Native executable
$(BIN_DIR)/simavr: $(OBJECTS) simavr/sim/avr_kind_emscripten.o simavr/sim/run_avr.c
	@echo "ðŸ“¦ Building native executable..."
	@mkdir -p $(BIN_DIR)
	$(CC) $(CFLAGS) -o $@ $^
	@echo "âœ… Native executable built: $@"

# Compile object files
%.o: %.c
	@echo "ðŸ”§ Compiling $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Install headers
install-headers:
	@echo "ðŸ“ Installing headers..."
	@mkdir -p $(INCLUDE_DIR)
	@cp -r cores/*.h $(INCLUDE_DIR)/ 2>/dev/null || true
	@cp -r sim/*.h $(INCLUDE_DIR)/ 2>/dev/null || true
	@echo "âœ… Headers installed to $(INCLUDE_DIR)/"

simavr/sim/avr_kind_emscripten.o:
	@echo "ðŸ”§ Generating avr_kind_emscripten.c..."
	@echo '#include <stdlib.h>' > simavr/sim/avr_kind_emscripten.c
	@echo '#include "sim_avr.h"' >> simavr/sim/avr_kind_emscripten.c
	@echo '#include "sim_core_decl.h"' >> simavr/sim/avr_kind_emscripten.c
	@echo 'const struct avr_kind_t * avr_kind[] = {' >> simavr/sim/avr_kind_emscripten.c
	@for core in simavr/cores/*.c ; do \
		if grep -q "SIM_MMCU" $$core; then \
			file=$${core}; global=$${core/simavr\/cores\/sim_}; global=$${global/.c}; \
			echo "&$$global," >> simavr/sim/avr_kind_emscripten.c; \
		fi \
	done
	@echo 'NULL' >> simavr/sim/avr_kind_emscripten.c
	@echo '};' >> simavr/sim/avr_kind_emscripten.c
	$(CC) $(CFLAGS) $(INCLUDES) -c simavr/sim/avr_kind_emscripten.c -o simavr/sim/avr_kind_emscripten.o

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -rf $(OBJECTS) $(LIB_DIR)/*.a $(LIB_DIR)/*.so $(BIN_DIR)/simavr
	@rm -f simavr/sim/sim_core_config.h simavr/sim/sim_core_decl.h simavr/sim/avr_kind_emscripten.c
	@echo "âœ… Clean complete"

# Test the build
test: $(BIN_DIR)/simavr
	@echo "ðŸ§ª Testing native SimAVR build..."
	@$(BIN_DIR)/simavr --help || echo "âœ… SimAVR executable built successfully"

# Show build info
info:
	@echo "ðŸ”§ Native SimAVR Build Configuration:"
	@echo "   CC: $(CC)"
	@echo "   CFLAGS: $(CFLAGS)"
	@echo "   Sources: $(words $(SOURCES)) files"
	@echo "   Libraries: $(LIB_DIR)/libsimavr.a, $(LIB_DIR)/libsimavr.so"
	@echo "   Executable: $(BIN_DIR)/simavr"

.PHONY: all clean test info install-headers
